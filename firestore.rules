rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - users can read their own data, but only update non-sensitive fields
    // Sensitive fields (credits, isPremium, premium_status, subscription_*) are only modified by backend Admin SDK
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow initial profile creation with safe defaults only
      // Credits start at 5 - restoration logic uses SET (not increment) to prevent exploitation
      allow create: if request.auth != null &&
                       request.auth.uid == userId &&
                       request.resource.data.credits == 5 &&
                       request.resource.data.isPremium == false &&
                       request.resource.data.premium_status == null;

      // Allow update only for non-sensitive fields (block financial/subscription fields)
      allow update: if request.auth != null &&
                       request.auth.uid == userId &&
                       // Prevent modification of sensitive fields
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                         'credits',
                         'isPremium',
                         'premium_status',
                         'subscription_id',
                         'subscription_status',
                         'subscription_price_id',
                         'paddle_customer_id'
                       ]);

      // Allow users to delete their own account
      allow delete: if request.auth != null && request.auth.uid == userId;

      // Subcollection: transactions - read only (backend creates via Admin SDK)
      match /transactions/{transactionId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        // Create/write only allowed via Admin SDK (backend)
      }
    }

    // Images collection - users can read and write their own images
    match /images/{imageId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Generations collection - users can read and write their own generations
    match /generations/{generationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Consents collection - users can create their own consent records
    match /consents/{consentId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Feedback collection - users can submit their own feedback/deletion reasons
    match /feedback/{feedbackId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
